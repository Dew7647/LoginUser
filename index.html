<!doctype html>
<html lang="th" class="h-full">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PSRU ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Sarabun', sans-serif; background-color: #f3f4f6; }
    .hidden { display: none; }
    .nav-active { color: #7c3aed; border-top: 3px solid #7c3aed; }
  </style>
</head>
<body class="h-full flex flex-col">

  <div id="login-screen" class="flex-1 flex items-center justify-center p-4 bg-gradient-to-br from-indigo-600 to-purple-700">
    <div class="bg-white p-8 rounded-3xl shadow-2xl w-full max-w-sm">
      <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h2>
      <form id="login-form" class="space-y-4">
        <input type="text" id="sid" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤" required class="w-full p-3 border rounded-xl outline-none focus:ring-2 focus:ring-purple-500">
        <input type="password" id="bday" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô (‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î ‡∏ß‡∏ß‡∏î‡∏î‡∏õ‡∏õ‡∏õ‡∏õ)" required class="w-full p-3 border rounded-xl outline-none focus:ring-2 focus:ring-purple-500">
        <button type="submit" id="login-btn" class="w-full py-3 bg-purple-600 text-white rounded-xl font-bold">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
        <button type="button" onclick="showRegister()" class="w-full text-sm text-gray-500 mt-4 underline text-center block">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ? ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</button>
      </form>
    </div>
  </div>

  <div id="register-screen" class="hidden flex-1 flex items-center justify-center p-4 bg-gradient-to-br from-teal-500 to-emerald-600">
    <div class="bg-white p-8 rounded-3xl shadow-2xl w-full max-w-sm">
      <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡∏°‡πà</h2>
      <form id="register-form" class="space-y-4">
        <input type="text" id="reg-sid" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤" required class="w-full p-3 border rounded-xl outline-none focus:ring-2 focus:ring-teal-500">
        <input type="text" id="reg-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•" required class="w-full p-3 border rounded-xl outline-none focus:ring-2 focus:ring-teal-500">
        <input type="password" id="reg-pass" placeholder="‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô (‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î ‡∏ß‡∏ß‡∏î‡∏î‡∏õ‡∏õ‡∏õ‡∏õ)" required class="w-full p-3 border rounded-xl outline-none focus:ring-2 focus:ring-teal-500">
        <button type="submit" id="reg-btn" class="w-full py-3 bg-teal-600 text-white rounded-xl font-bold">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</button>
        <button type="button" onclick="showLogin()" class="w-full text-sm text-gray-500 mt-4 underline text-center block">‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÅ‡∏•‡πâ‡∏ß? ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
      </form>
    </div>
  </div>

  <div id="app-screen" class="hidden flex-1 flex flex-col overflow-hidden">
    <header class="bg-white p-4 shadow-sm flex justify-between items-center">
      <div><h1 id="user-name" class="font-bold text-gray-800">‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤</h1><p id="user-id" class="text-xs text-gray-500"></p></div>
      <button onclick="location.reload()" class="text-xs text-red-500 font-bold border border-red-200 px-3 py-1 rounded-lg">‡∏≠‡∏≠‡∏Å</button>
    </header>

    <main class="flex-1 overflow-y-auto p-4 space-y-4">
      <section id="menu-checkin" class="space-y-4">
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
          <h3 class="font-bold mb-4">üìç ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</h3>
          <select id="location" class="w-full p-3 bg-gray-50 border rounded-xl mb-4">
            <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà --</option>
            <option value="16.82,100.22">‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏ä‡∏¥‡∏£‡πÇ‡∏ä‡∏ï‡∏¥</option>
            <option value="16.81,100.22">‡∏™‡∏ô‡∏≤‡∏°‡∏Å‡∏µ‡∏¨‡∏≤</option>
          </select>
          <div class="flex gap-2 mb-4">
            <label class="flex-1 text-center p-3 border rounded-xl cursor-pointer has-[:checked]:bg-purple-50 has-[:checked]:border-purple-500">
              <input type="radio" name="ctype" value="‡πÄ‡∏Ç‡πâ‡∏≤" checked class="hidden">‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏Ç‡πâ‡∏≤
            </label>
            <label class="flex-1 text-center p-3 border rounded-xl cursor-pointer has-[:checked]:bg-purple-50 has-[:checked]:border-purple-500">
              <input type="radio" name="ctype" value="‡∏≠‡∏≠‡∏Å" class="hidden">‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏≠‡∏Å
            </label>
          </div>
          <button id="btn-save" class="w-full py-4 bg-purple-600 text-white rounded-xl font-bold shadow-lg">‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</button>
        </div>
      </section>

      <section id="menu-stats" class="hidden space-y-4">
        <div class="bg-purple-600 p-8 rounded-3xl text-white text-center shadow-lg">
          <p class="text-purple-200">‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏™‡∏∞‡∏™‡∏°‡∏£‡∏ß‡∏°</p>
          <h2 id="display-hours" class="text-6xl font-black my-2">0</h2>
          <p class="text-sm opacity-80">‡∏ô‡∏±‡∏ö‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠ "‡πÄ‡∏Ç‡πâ‡∏≤" ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</p>
        </div>
      </section>
    </main>

    <nav class="bg-white border-t flex justify-around py-3 pb-8">
      <button onclick="tab('checkin')" id="nav-checkin" class="flex-1 nav-active text-center">üìç<br><span class="text-[10px]">‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠</span></button>
      <button onclick="tab('stats')" id="nav-stats" class="flex-1 text-gray-400 text-center">üìä<br><span class="text-[10px]">‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥</span></button>
    </nav>
  </div>

  <script>
    const SCRIPT_URL = "‡∏ß‡∏≤‡∏á_URL_APPS_SCRIPT_‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà";
    let currentUser = null;

    function showRegister() { document.getElementById('login-screen').classList.add('hidden'); document.getElementById('register-screen').classList.remove('hidden'); }
    function showLogin() { document.getElementById('register-screen').classList.add('hidden'); document.getElementById('login-screen').classList.remove('hidden'); }

    // ‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô
    document.getElementById('register-form').onsubmit = async (e) => {
      e.preventDefault();
      const btn = document.getElementById('reg-btn'); btn.disabled = true; btn.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô...";
      const res = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({
        action: "register",
        student_id: document.getElementById('reg-sid').value,
        student_name: document.getElementById('reg-name').value,
        password: document.getElementById('reg-pass').value
      })});
      const result = await res.json();
      alert(result.success ? "‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö" : result.message);
      if(result.success) showLogin();
      btn.disabled = false; btn.innerText = "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô";
    };

    // ‡∏£‡∏∞‡∏ö‡∏ö Login
    document.getElementById('login-form').onsubmit = async (e) => {
      e.preventDefault();
      const btn = document.getElementById('login-btn'); btn.disabled = true;
      const res = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({
        action: "login",
        student_id: document.getElementById('sid').value,
        password: document.getElementById('bday').value
      })});
      const result = await res.json();
      if(result.success) {
        currentUser = { id: document.getElementById('sid').value, name: result.name };
        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('app-screen').classList.remove('hidden');
        document.getElementById('user-name').innerText = result.name;
        document.getElementById('user-id').innerText = "‡∏£‡∏´‡∏±‡∏™: " + currentUser.id;
        document.getElementById('display-hours').innerText = result.hours;
      } else { alert(result.message); }
      btn.disabled = false;
    };

    function tab(name) {
      document.getElementById('menu-checkin').classList.toggle('hidden', name !== 'checkin');
      document.getElementById('menu-stats').classList.toggle('hidden', name !== 'stats');
      document.getElementById('nav-checkin').className = name === 'checkin' ? 'flex-1 nav-active text-center' : 'flex-1 text-gray-400 text-center';
      document.getElementById('nav-stats').className = name === 'stats' ? 'flex-1 nav-active text-center' : 'flex-1 text-gray-400 text-center';
    }

    document.getElementById('btn-save').onclick = async () => {
      if(!document.getElementById('location').value) return alert("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡πà‡∏≠‡∏ô");
      const btn = document.getElementById('btn-save'); btn.disabled = true;
      navigator.geolocation.getCurrentPosition(async (pos) => {
        await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({
          action: "checkin",
          student_id: currentUser.id,
          student_name: currentUser.name,
          check_type: document.querySelector('input[name="ctype"]:checked').value,
          latitude: pos.coords.latitude, longitude: pos.coords.longitude
        })});
        alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!"); btn.disabled = false;
      }, () => { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î GPS"); btn.disabled = false; });
    };
  </script>
</body>
</html>
